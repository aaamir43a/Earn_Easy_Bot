<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Earn Easy</title>
    <!-- টেলিগ্রাম এবং বিজ্ঞাপন SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src='//libtl.com/sdk.js' data-zone='9646545' data-sdk='show_9646545'></script>
    
    <!-- Firebase SDKs (Compat version for easier use) -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

    <!-- CSS স্টাইল -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        :root {
            --primary-color: #149A9B; --accent-color: #FFB800; --text-color: #2C3E50; --light-text-color: #7f8c8d;
            --background-color: #F7F9FA; --card-bg: #FFFFFF; --success-color: #27ae60; --danger-color: #e74c3c; --nav-bg: #2C3E50;
        }
        html { scroll-behavior: smooth; }
        body { font-family: 'Poppins', sans-serif; margin: 0; background-color: var(--background-color); color: var(--text-color); }
        .loader-wrapper { display: flex; justify-content: center; align-items: center; min-height: 100vh; font-size: 1.2em; color: var(--primary-color); }
        .app-container { max-width: 450px; margin: auto; background-color: var(--background-color); min-height: 100vh; position: relative; padding-bottom: 70px; overflow-x: hidden; display: none; }
        body.loaded .loader-wrapper { display: none; }
        body.loaded .app-container { display: block; }
        .page { display: none; padding: 20px; box-sizing: border-box; }
        .page.active { display: block; }
        .header { background-color: var(--primary-color); color: white; padding: 20px; display: flex; align-items: center; border-bottom-left-radius: 25px; border-bottom-right-radius: 25px; position: relative; margin: -20px -20px 25px -20px; }
        .header img { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--card-bg); margin-right: 15px; }
        .header .user-info { flex-grow: 1; }
        .header .user-info h1 { margin: 0; font-size: 1.2em; font-weight: 600; }
        .header .user-info p { margin: 0; font-size: 1em; opacity: 0.9; }
        #home-page { padding: 0; }
        #home-page > .header { margin: 0 0 20px 0; border-radius: 0; }
        #home-page .main-content { padding: 20px; }
        .main-title { text-align: center; color: var(--primary-color); font-size: 1.8em; font-weight: 600; margin-bottom: 25px; margin-top:0; }
        .card, .stat-card, .withdraw-card { background-color: var(--card-bg); border-radius: 16px; padding: 25px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06); border: 1px solid #EAECEE; margin-bottom: 20px; text-align: left; }
        #home-page .welcome-card h2 { margin-top: 0; margin-bottom: 5px; font-size: 1.4em; font-weight: 600; color: var(--text-color);}
        #home-page .welcome-card p { margin-top: 0; margin-bottom: 20px; color: var(--light-text-color); }
        #home-page .welcome-card .earn-now-btn { background-color: var(--primary-color); color: white; border: none; padding: 12px 30px; border-radius: 12px; font-size: 1em; cursor: pointer; font-weight: 500; }
        #home-page .welcome-card .illustration { text-align: center; margin-top: 20px; height: 160px; border-radius: 12px; overflow: hidden; }
        #home-page .welcome-card .illustration img { width: 100%; height: 100%; object-fit: cover; }
        #home-page .stats-grid { display: flex; flex-direction: column; gap: 15px; }
        #home-page .stat-card { color: var(--text-color); }
        #home-page .stat-card.earnings { border-left: 5px solid var(--primary-color); }
        #home-page .stat-card.ads-watched { border-left: 5px solid var(--accent-color); }
        #home-page .stat-card .value { font-size: 2em; font-weight: 700; margin: 5px 0; color: var(--text-color); }
        #home-page .stat-card .label { font-size: 0.9em; color: var(--light-text-color); }
        .earn-withdraw-container { max-width: 400px; width: 100%; margin: auto; }
        .card-title { color: var(--primary-color); font-size: 1.5em; font-weight: 600; margin-top: 0; margin-bottom: 20px; }
        .card p { font-size: 1em; color: var(--text-color); margin: 8px 0; font-weight: 500; }
        .card p span { font-weight: 700; }
        .task-info .completed-val { color: var(--success-color); }
        .task-info .remaining-val { color: var(--danger-color); }
        .progress-bar-container { width: 100%; height: 16px; background-color: #e9ecef; border-radius: 8px; overflow: hidden; margin: 25px 0 20px 0; }
        .progress-bar-fill { height: 100%; width: 0%; background-color: var(--success-color); border-radius: 8px; transition: width 0.4s ease-in-out; color: white; display: flex; align-items: center; justify-content: center; font-size: 0.8em; font-weight: 600; }
        #custom-notification { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background-color: var(--success-color); color: white; padding: 12px 25px; border-radius: 12px; z-index: 1000; font-weight: 500; font-size: 0.9em; opacity: 0; transition: opacity 0.4s ease, top 0.4s ease; visibility: hidden; }
        #custom-notification.show { visibility: visible; opacity: 1; top: 20px; }
        .divider { border: 0; height: 1px; background-color: #e9ecef; margin: 25px 0; }
        .btn, .submit-btn { display: flex; align-items: center; justify-content: center; width: 100%; padding: 15px; border: none; border-radius: 12px; font-size: 1.1em; font-weight: 600; color: #fff; cursor: pointer; transition: transform 0.2s; box-sizing: border-box; }
        .btn:disabled, .submit-btn:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        .btn:active:not(:disabled), .submit-btn:active:not(:disabled) { transform: scale(0.98); }
        .btn-start, .submit-btn { background-color: var(--primary-color); }
        .btn-invite { background-color: var(--accent-color); color: var(--text-color); }
        .btn-click { background-color: #9b59b6; }
        .btn svg { margin-left: 10px; }
        #withdraw-page .withdraw-card { padding: 30px; }
        #withdraw-page .balance { color: var(--light-text-color); font-size: 1.2em; font-weight: 500; margin-bottom: 30px; text-align: center; }
        #withdraw-page .balance span { font-weight: 700; color: var(--success-color); }
        #withdraw-page .card-title { color: var(--primary-color); font-size: 1.6em; }
        #withdraw-page .form-group { margin-bottom: 25px; }
        #withdraw-page .form-group > label { color: var(--text-color); font-weight: 600; margin-bottom: 12px; font-size: 1em; display: block; }
        #withdraw-page .input-wrapper { position: relative; display: flex; align-items: center; }
        #withdraw-page .input-wrapper .icon { position: absolute; left: 0; height: 100%; width: 50px; display: flex; justify-content: center; align-items: center; border-right: 1px solid #e0e0e0; }
        #withdraw-page .input-wrapper .icon svg { fill: var(--primary-color); }
        #withdraw-page .form-control { width: 100%; height: 50px; padding: 10px 15px 10px 65px; border: 1px solid #ced4da; border-radius: 12px; font-size: 1em; font-family: 'Poppins', sans-serif; transition: border-color 0.2s; box-sizing: border-box; }
        #withdraw-page select.form-control { cursor: pointer; appearance: none; -webkit-appearance: none; -moz-appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23333' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 15px center; }
        #withdraw-page .form-control:focus { outline: none; border-color: var(--primary-color); }
        #withdraw-page input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        #withdraw-page #operator-section { display: none; }
        #withdraw-page .submit-btn { margin-top: 10px; }
        #profile-page .user-info-card { background: var(--primary-color); color: white; padding: 30px; border-radius: 20px; text-align: center; margin-bottom: 25px; box-shadow: 0 10px 20px rgba(20, 154, 155, 0.25); }
        #profile-page .user-info-card .profile-pic { width: 100px; height: 100px; border-radius: 50%; border: 4px solid white; margin-bottom: 15px; }
        #profile-page .user-info-card .user-name { font-size: 1.5em; font-weight: 600; margin: 0 0 5px; }
        #profile-page .user-info-card .username { font-size: 0.9em; opacity: 0.8; margin-bottom: 20px; }
        #profile-page .balance-display { background: var(--accent-color); padding: 10px 25px; border-radius: 12px; display: inline-block; color: var(--text-color); }
        #profile-page .balance-label { font-size: 0.9em; opacity: 0.8; display: block; font-weight: 500; }
        #profile-page .balance-value { font-size: 1.6em; font-weight: 600; }
        #profile-page .profile-stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-item { background-color: var(--card-bg); padding: 20px; border-radius: 16px; text-align: center; border: 1px solid #EAECEE; }
        .stat-item.full-width { grid-column: 1 / -1; }
        .stat-item .stat-value { font-size: 1.5em; font-weight: 600; color: var(--text-color); display: block; margin-bottom: 5px;}
        .stat-item .stat-label { font-size: 0.9em; color: var(--light-text-color); font-weight: 600; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; max-width: 450px; margin: auto; background-color: var(--nav-bg); display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 100; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--light-text-color); text-decoration: none; font-size: 0.8em; cursor: pointer; transition: color 0.2s; }
        .nav-item.active { color: var(--primary-color); }
        .nav-item svg { width: 24px; height: 24px; margin-bottom: 3px; fill: currentColor; }
        /* বাকি CSS কোড এখানে যোগ করা যেতে পারে */
    </style>
</head>
<body>
    
    <div class="loader-wrapper">
        <div id="loader">Loading App...</div>
    </div>

    <div class="app-container">
        <!-- হোম পেজ -->
        <div id="home-page" class="page active">
             <header class="header">
                <img src="" class="dynamic-profile-pic" alt="Profile">
                <div class="user-info">
                    <h1 class="user-dynamic-name"></h1>
                    <p>Balance: <span class="header-available-balance">0.00</span></p>
                </div>
            </header>
            <main class="main-content">
                <div class="card welcome-card">
                    <h2>Ready to Earn?</h2>
                    <p>Complete your daily tasks and watch your earnings grow.</p>
                    <button id="home-start-earning" class="earn-now-btn">Start Earning</button>
                    <div class="illustration">
                        <img src="https://i.ibb.co/chwt44Nq/Background-photo.png" alt="Illustration">
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card earnings">
                        <div class="label">Total Earnings</div>
                        <div id="home-total-earnings" class="value">0.00</div>
                    </div>
                    <div class="stat-card ads-watched">
                        <div class="label">Total Ads Watched</div>
                        <div id="home-total-ads" class="value">0</div>
                    </div>
                </div>
            </main>
        </div>

        <!-- আর্ন পেজ -->
        <div id="earn-page" class="page">
            <div class="earn-withdraw-container">
                <h1 class="main-title">Earn Rewards</h1>
                <div id="custom-notification"></div>
                <div class="card">
                    <h2 class="card-title">Today's Tasks</h2>
                    <div class="task-info">
                        <p>Total Tasks: <span id="earn-task-limit">200</span></p>
                        <p>Completed: <span id="earn-completed-tasks" class="completed-val">0</span></p>
                        <p>Remaining: <span id="earn-remaining-tasks" class="remaining-val">200</span></p>
                    </div>
                    <div class="progress-bar-container">
                        <div id="task-progress-bar" class="progress-bar-fill"></div>
                    </div>
                    <button id="earn-start-task-btn" class="btn btn-start">Start View <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 0 24 24" width="18px" fill="#FFFFFF"><path d="M8 5v14l11-7L8 5z"/></svg></button>
                    <button id="earn-start-click-btn" class="btn btn-click" style="display: none; margin-top: 15px;">Start Click <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 0 24 24" width="18px" fill="#FFFFFF"><path d="M8 5v14l11-7L8 5z"/></svg></button>
                </div>
                <div class="card">
                    <h2 class="card-title">Refer & Earn</h2>
                    <div class="refer-info"><p>Total Referrals: <span id="earn-total-referrals">0</span></p></div>
                    <hr class="divider">
                    <button id="invite-friends-btn" class="btn btn-invite">Invite Friends <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 0 24 24" width="20px" fill="currentColor"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3s3-1.34 3-3-1.34-3-3-3z"/></svg></button>
                </div>
            </div>
        </div>

        <!-- উইথড্র পেজ -->
        <div id="withdraw-page" class="page">
             <h1 class="main-title">Withdraw Funds</h1>
             <p class="balance">Available Balance: <span id="withdraw-available-balance">0.00</span></p>
             <div class="withdraw-card">
                 <h2 class="card-title">Request Withdrawal</h2>
                 <form id="withdraw-form">
                    <!-- আগের মতোই সব ফর্ম উপাদান এখানে থাকবে -->
                 </form>
             </div>
        </div>

        <!-- প্রোফাইল পেজ -->
        <div id="profile-page" class="page">
            <h1 class="main-title">My Profile</h1>
            <div class="user-info-card">
                <img src="" alt="User Profile Picture" class="profile-pic dynamic-profile-pic">
                <h2 class="user-name user-dynamic-name"></h2>
                <p id="profile-username" class="username"></p>
                <div class="balance-display">
                    <span class="balance-label">Available Balance</span>
                    <span id="profile-current-balance" class="balance-value">0.00</span>
                </div>
            </div>
            <div class="profile-stats-grid">
                <div class="stat-item full-width">
                    <span id="profile-total-earnings" class="stat-value">0.00</span>
                    <span class="stat-label">Total Earnings</span>
                </div>
                <div class="stat-item">
                    <span id="profile-total-ads" class="stat-value">0</span>
                    <span class="stat-label">Total Ads Watched</span>
                </div>
                <div class="stat-item">
                    <span id="profile-referral-count" class="stat-value">0</span>
                    <span class="stat-label">Referrals</span>
                </div>
            </div>
        </div>

        <!-- নেভিগেশন বার আগের মতোই থাকবে -->
        <nav class="bottom-nav">
            <a data-page="home-page" class="nav-item active"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5z"/></svg><span>Home</span></a>
            <a data-page="earn-page" class="nav-item"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zM4 18V8h16v10c0 .55-.45 1-1 1H5c-.55 0-1-.45-1-1zm11-6H9v2h6v-2z" opacity=".3"/><path d="M20 6H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm0 12H4V8h16v10zM9 12h6v2H9z"/></svg><span>Earn</span></a>
            <a data-page="withdraw-page" class="nav-item"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M5 5c0 .55.45 1 1 1h12c.55 0 1-.45 1-1s-.45-1-1-1H6c-.55 0-1 .45-1 1zm13.62 3.5L15 12.12V18h-2v-5.88L9.38 8.5H18.62zM21 4H3v2l8 9v7h2v-7l8-9V4z"/></svg><span>Withdraw</span></a>
            <a data-page="profile-page" class="nav-item"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg><span>Profile</span></a>
        </nav>
    </div>

    <!-- =================================================================== -->
    <!-- ============== ফাইনাল এবং ১০০% নির্ভুল JAVASCRIPT কোড ============== -->
    <!-- =================================================================== -->
    <script>
        // ধাপ ১ থেকে পাওয়া আপনার Firebase কনফিগারেশন এখানে পেস্ট করুন
        const firebaseConfig = {
          apiKey: "AIzaSyCJ2K5oH8Zbeqy36VF9Vh9j8iUyqWbSxhE",
          authDomain: "earn-easy-ot.firebaseapp.com",
          projectId: "earn-easy-ot",
          storageBucket: "earn-easy-ot.firebasestorage.app",
          messagingSenderId: "831993475766",
          appId: "1:831993475766:web:7c60ba5b12cf66971dac17"
        };

        // --- এই দুটি জায়গা আপনাকে অবশ্যই পরিবর্তন করতে হবে ---
        // ১. উপরের firebaseConfig অবজেক্টটি আপনার নিজের কনফিগারেশন দিয়ে পরিবর্তন করুন।
        // ২. নিচের MY_BOT_USERNAME-এ আপনার টেলিগ্রাম বটের ইউজারনেম দিন।
        const MY_BOT_USERNAME = 'EarnEasyOfficial_bot';
        // ---------------------------------------------

        // Firebase চালু করুন
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const tg = window.Telegram.WebApp;

        let currentUserData = null;
        let isTaskRunning = false;
        let notificationTimeout;
        const dailyTaskLimit = 200;
        const CLICK_BUTTON_VISIBILITY_MULTIPLIER = 5;

        const loaderEl = document.getElementById('loader');

        tg.ready(() => {
            auth.signInAnonymously().catch(error => {
                loaderEl.textContent = `Auth Error: ${error.message}`;
            });

            auth.onAuthStateChanged(async (firebaseUser) => {
                if (firebaseUser) {
                    try {
                        if (!tg.initDataUnsafe || !tg.initDataUnsafe.user) {
                             throw new Error("Telegram user data not available.");
                        }

                        const user = tg.initDataUnsafe.user;
                        const userRef = db.collection('users').doc(String(user.id));
                        
                        // ডেটাবেস থেকে রিয়েল-টাইম আপডেট শোনার জন্য
                        userRef.onSnapshot(async (doc) => {
                            if (!doc.exists) {
                                const startParam = tg.initDataUnsafe.start_param;
                                const referred_by = startParam || null;
                                
                                currentUserData = {
                                    id: user.id,
                                    first_name: user.first_name || 'User',
                                    last_name: user.last_name || '',
                                    username: user.username || 'N/A',
                                    available_balance: 0.00,
                                    total_earnings: 0.00,
                                    lifetime_ads_watched: 0,
                                    daily_ads_completed: 0,
                                    last_ad_date: new Date().toISOString().split('T')[0],
                                    referral_count: 0,
                                    referred_by: referred_by,
                                    join_date: firebase.firestore.FieldValue.serverTimestamp()
                                };
                                await userRef.set(currentUserData);
                                
                                if(referred_by){
                                    const referrerRef = db.collection('users').doc(referred_by);
                                    await referrerRef.update({ referral_count: firebase.firestore.FieldValue.increment(1) });
                                }
                            } else {
                                currentUserData = doc.data();
                                const today = new Date().toISOString().split('T')[0];
                                if(currentUserData.last_ad_date !== today){
                                    await userRef.update({ daily_ads_completed: 0, last_ad_date: today });
                                    currentUserData.daily_ads_completed = 0;
                                }
                            }
                            
                            document.body.classList.add('loaded');
                            updateAllUI(currentUserData);

                        }, error => {
                            loaderEl.textContent = `Firestore Error: ${error.message}`;
                        });
                        
                        setupEventListeners();

                    } catch (error) {
                        loaderEl.textContent = `Initialization Error: ${error.message}`;
                    }
                }
            });
        });
        
        function updateAllUI(user) {
            if (!user) return;
            const fullName = `${user.first_name || ''} ${user.last_name || ''}`.trim() || 'User';
            document.querySelectorAll('.user-dynamic-name').forEach(el => el.textContent = fullName);
            
            const profilePicUrl = (tg.initDataUnsafe.user && tg.initDataUnsafe.user.photo_url) ? tg.initDataUnsafe.user.photo_url : 'https://i.ibb.co/RkQsb051/Profile-Picture.png';
            document.querySelectorAll('.dynamic-profile-pic').forEach(el => el.src = profilePicUrl);
            
            document.getElementById('profile-username').textContent = user.username ? `@${user.username}` : 'No Username';
            
            const fAvailable = (user.available_balance || 0).toFixed(2);
            const fTotal = (user.total_earnings || 0).toFixed(2);
            document.querySelectorAll('.header-available-balance').forEach(el => el.textContent = fAvailable);
            document.getElementById('home-total-earnings').textContent = fTotal;
            document.getElementById('withdraw-available-balance').textContent = fAvailable;
            document.getElementById('profile-current-balance').textContent = fAvailable;
            document.getElementById('profile-total-earnings').textContent = fTotal;

            const lifetimeAds = user.lifetime_ads_watched || 0;
            document.getElementById('home-total-ads').textContent = lifetimeAds;
            document.getElementById('profile-total-ads').textContent = lifetimeAds;
            
            const dailyCompleted = user.daily_ads_completed || 0;
            document.getElementById('earn-completed-tasks').textContent = dailyCompleted;
            const remaining = dailyTaskLimit - dailyCompleted;
            document.getElementById('earn-remaining-tasks').textContent = remaining > 0 ? remaining : 0;
            
            const progressBar = document.getElementById('task-progress-bar');
            const percentage = dailyTaskLimit > 0 ? (dailyCompleted / dailyTaskLimit) * 100 : 0;
            progressBar.style.width = percentage + '%';
            progressBar.textContent = Math.round(percentage) + '%';
            
            const earnStartTaskBtn = document.getElementById('earn-start-task-btn');
            const earnStartClickBtn = document.getElementById('earn-start-click-btn');
            earnStartTaskBtn.disabled = dailyCompleted >= dailyTaskLimit;
            earnStartClickBtn.disabled = dailyCompleted >= dailyTaskLimit;
            
            const showClickBtn = (dailyCompleted > 0 && dailyCompleted % CLICK_BUTTON_VISIBILITY_MULTIPLIER === 0);
            earnStartClickBtn.style.display = showClickBtn ? 'flex' : 'none';
            earnStartTaskBtn.style.display = showClickBtn ? 'none' : 'flex';
            
            const referralCount = user.referral_count || 0;
            document.getElementById('earn-total-referrals').textContent = referralCount;
            document.getElementById('profile-referral-count').textContent = referralCount;

            setupReferralLink(user.id);
        }

        function setupEventListeners() {
            document.getElementById('earn-start-task-btn').addEventListener('click', () => startTask('View'));
            document.getElementById('earn-start-click-btn').addEventListener('click', () => startTask('Click'));
            
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetPageId = item.getAttribute('data-page');
                    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                    document.getElementById(targetPageId).classList.add('active');
                    navItems.forEach(nav => nav.classList.remove('active'));
                    item.classList.add('active');
                    window.scrollTo(0, 0);
                });
            });
            // ... অন্যান্য সব ইভেন্ট লিসেনার এখানে যোগ হবে ...
        }

        async function startTask(taskType) {
            if (isTaskRunning || !currentUserData) return;
            if (currentUserData.daily_ads_completed >= dailyTaskLimit) {
                alert('Daily task limit reached. Try again tomorrow.');
                return;
            }
            
            isTaskRunning = true;
            document.getElementById('earn-start-task-btn').disabled = true;
            document.getElementById('earn-start-click-btn').disabled = true;

            try {
                if (typeof show_9646545 === 'function') {
                    await show_9646545();
                    const reward = (taskType === 'Click') ? 0.25 : 0.10;
                    const userRef = db.collection('users').doc(String(currentUserData.id));
                    
                    await userRef.update({
                        available_balance: firebase.firestore.FieldValue.increment(reward),
                        total_earnings: firebase.firestore.FieldValue.increment(reward),
                        lifetime_ads_watched: firebase.firestore.FieldValue.increment(1),
                        daily_ads_completed: firebase.firestore.FieldValue.increment(1),
                        last_ad_date: new Date().toISOString().split('T')[0]
                    });
                    
                    showCustomNotification(`Task completed! You earned ${reward.toFixed(2)} BDT.`);
                } else {
                    throw new Error("Ad system (show_9646545) not found.");
                }
            } catch(error) {
                alert(`Ad Error: ${error.message}`);
            } finally {
                isTaskRunning = false;
                // UI is updated by onSnapshot, so no need to disable buttons manually here.
            }
        }
        
        function showCustomNotification(message) {
            const el = document.getElementById('custom-notification');
            clearTimeout(notificationTimeout);
            el.textContent = message;
            el.classList.add('show');
            notificationTimeout = setTimeout(() => {
                el.classList.remove('show');
            }, 4000);
        }

        function setupReferralLink(userId) {
            const referralLink = `https://t.me/${MY_BOT_USERNAME}?startapp=${userId}`;
            document.getElementById('referral-link').value = referralLink;
        }

    </script>
</body>
</html>