<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Earn Easy</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src='//libtl.com/sdk.js' data-zone='9646545' data-sdk='show_9646545'></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <style>
        body{font-family:sans-serif;margin:0;background:#f7f9fa;color:#2c3e50}
        .loader-wrapper{display:flex;justify-content:center;align-items:center;flex-direction:column;min-height:100vh;font-size:1.2em;color:#149a9b;padding:20px;text-align:center}
        .loader-wrapper pre{background:#ffebee;border:1px solid #e57373;padding:15px;border-radius:8px;color:#c62828;font-size:11px;white-space:pre-wrap;word-wrap:break-word;text-align:left;max-width:100%;box-sizing:border-box;margin-top:20px}
        .app-container{display:none}
        body.loaded .loader-wrapper{display:none}
        body.loaded .app-container{display:block}
    </style>
</head>
<body>
    <div class="loader-wrapper">
        <div id="loader-text">Loading App...</div>
        <pre id="error-log" style="display:none;"></pre>
    </div>
    <div class="app-container">
        <!-- আপনার অ্যাপের HTML এখানে থাকবে -->
        <h1>Welcome to Earn Easy!</h1>
        <p>User: <span id="user-name"></span></p>
        <p>Balance: <span id="user-balance"></span></p>
    </div>

    <script>
        const loaderText = document.getElementById('loader-text');
        const errorLog = document.getElementById('error-log');

        // গ্লোবাল এরর হ্যান্ডলার: যেকোনো আনক্যাচড ভুল ধরবে
        window.onerror = function(message, source, lineno, colno, error) {
            showError("A global JavaScript error occurred.", `Message: ${message}\nSource: ${source}\nLine: ${lineno}, Col: ${colno}\nError: ${error}`);
            return true;
        };

        function showError(message, error = '') {
            loaderText.textContent = message;
            errorLog.style.display = 'block';
            errorLog.textContent = error.toString();
            console.error(message, error);
        }

        try {
            const firebaseConfig = {
              apiKey: "AIzaSyCJ2K5oH8Zbeqy36VF9Vh9j8iUyqWbSxhE",
              authDomain: "earn-easy-ot.firebaseapp.com",
              projectId: "earn-easy-ot",
              storageBucket: "earn-easy-ot.firebasestorage.app",
              messagingSenderId: "831993475766",
              appId: "1:831993475766:web:7c60ba5b12cf66971dac17"
            };

            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const auth = firebase.auth();
            const tg = window.Telegram.WebApp;

            tg.ready(async () => {
                try {
                    loaderText.textContent = "Step 1: Authenticating...";
                    await auth.signInAnonymously();
                    
                    loaderText.textContent = "Step 2: Waiting for Auth State...";
                    auth.onAuthStateChanged(async (firebaseUser) => {
                        if (firebaseUser) {
                            try {
                                loaderText.textContent = "Step 3: Fetching Telegram User Data...";
                                if (!tg.initDataUnsafe || !tg.initDataUnsafe.user) {
                                    throw new Error("Telegram user data not found.");
                                }
                                const user = tg.initDataUnsafe.user;
                                const userRef = db.collection('users').doc(String(user.id));
                                
                                loaderText.textContent = "Step 4: Accessing Database...";
                                const doc = await userRef.get();

                                if (!doc.exists) {
                                     loaderText.textContent = "Step 5: Creating new user...";
                                     const newUser = { id: user.id, first_name: user.first_name || 'New User', available_balance: 0 };
                                     await userRef.set(newUser);
                                }
                                
                                loaderText.textContent = "Step 6: Loading App UI...";
                                document.body.classList.add('loaded');
                                
                                const userData = (await userRef.get()).data();
                                document.getElementById('user-name').textContent = userData.first_name;
                                document.getElementById('user-balance').textContent = (userData.available_balance || 0).toFixed(2);

                            } catch(error) {
                                showError("Error during data processing.", error);
                            }
                        } else {
                            showError("Firebase user is not authenticated.");
                        }
                    });

                } catch (error) {
                    showError("Error during app initialization.", error);
                }
            });

        } catch (error) {
            showError("A critical error occurred while initializing Firebase.", error);
        }
    </script>
</body>
</html>
