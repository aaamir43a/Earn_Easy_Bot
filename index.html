<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Earn Easy</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src='//libtl.com/sdk.js' data-zone='9646545' data-sdk='show_9646545'></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        :root{--primary-color:#149A9B;--accent-color:#FFB800;--text-color:#2C3E50;--light-text-color:#7f8c8d;--background-color:#F7F9FA;--card-bg:#FFFFFF;--success-color:#27ae60;--danger-color:#e74c3c;--nav-bg:#2C3E50}
        html{scroll-behavior:smooth}
        body{font-family:'Poppins',sans-serif;margin:0;background-color:var(--background-color);color:var(--text-color)}
        .loader-wrapper{display:flex;justify-content:center;align-items:center;flex-direction:column;min-height:100vh;font-size:1.2em;color:var(--primary-color);padding:20px;text-align:center}
        .loader-wrapper pre{background:#f1f1f1;padding:15px;border-radius:8px;color:var(--danger-color);font-size:10px;white-space:pre-wrap;word-wrap:break-word;text-align:left;max-width:100%;box-sizing:border-box}
        .app-container{max-width:450px;margin:auto;background-color:var(--background-color);min-height:100vh;position:relative;padding-bottom:70px;overflow-x:hidden;display:none}
        body.loaded .loader-wrapper{display:none}
        body.loaded .app-container{display:block}
        .page{display:none;padding:20px;box-sizing:border-box}.page.active{display:block}
        .header{background-color:var(--primary-color);color:#fff;padding:20px;display:flex;align-items:center;border-bottom-left-radius:25px;border-bottom-right-radius:25px;position:relative;margin:-20px -20px 25px}
        .header img{width:50px;height:50px;border-radius:50%;border:2px solid var(--card-bg);margin-right:15px}
        .header .user-info{flex-grow:1}.header .user-info h1{margin:0;font-size:1.2em;font-weight:600}.header .user-info p{margin:0;font-size:1em;opacity:.9}
        .main-title{text-align:center;color:var(--primary-color);font-size:1.8em;font-weight:600;margin-bottom:25px;margin-top:0}
        /* এখানে বাকি সব CSS কোড থাকবে */
    </style>
</head>
<body>
    <div class="loader-wrapper">
        <div id="loader-text">Loading App...</div>
        <pre id="error-log" style="display:none;"></pre>
    </div>
    <div class="app-container">
        <!-- আপনার অ্যাপের সম্পূর্ণ HTML অংশ এখানে থাকবে -->
        <!-- উদাহরণস্বরূপ: -->
        <div id="home-page" class="page active">
            <h1 class="main-title">Welcome</h1>
            <div class="card">
                <p>User: <span class="user-dynamic-name"></span></p>
                <p>Balance: <span class="header-available-balance">0.00</span></p>
            </div>
        </div>
    </div>

    <script>
        // আপনার দেওয়া Firebase কনফিগারেশন
        const firebaseConfig = {
          apiKey: "AIzaSyCJ2K5oH8Zbeqy36VF9Vh9j8iUyqWbSxhE",
          authDomain: "earn-easy-ot.firebaseapp.com",
          projectId: "earn-easy-ot",
          storageBucket: "earn-easy-ot.firebasestorage.app",
          messagingSenderId: "831993475766",
          appId: "1:831993475766:web:7c60ba5b12cf66971dac17"
        };
        
        // আপনার দেওয়া বটের ইউজারনেম
        const MY_BOT_USERNAME = 'EarnEasyOfficial_bot';

        const loaderText = document.getElementById('loader-text');
        const errorLog = document.getElementById('error-log');
        
        function showError(message, error = '') {
            loaderText.textContent = message;
            errorLog.style.display = 'block';
            errorLog.textContent = error.toString();
            console.error(error);
        }

        try {
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const auth = firebase.auth();
            const tg = window.Telegram.WebApp;

            tg.ready(async () => {
                try {
                    loaderText.textContent = "Authenticating...";
                    await auth.signInAnonymously();
                    
                    loaderText.textContent = "Fetching User Data...";
                    if (!tg.initDataUnsafe || !tg.initDataUnsafe.user) {
                        throw new Error("Telegram user data not found. Please restart the app.");
                    }

                    const user = tg.initDataUnsafe.user;
                    const userRef = db.collection('users').doc(String(user.id));
                    
                    userRef.onSnapshot(async (doc) => {
                        loaderText.textContent = "Processing data...";
                        let userData = doc.data();

                        if (!doc.exists) {
                            loaderText.textContent = "Creating new user profile...";
                            const startParam = tg.initDataUnsafe.start_param;
                            const referred_by = (startParam && startParam !== String(user.id)) ? startParam : null;

                            userData = {
                                id: user.id,
                                first_name: user.first_name || 'User',
                                last_name: user.last_name || '',
                                username: user.username || 'N/A',
                                available_balance: 0.00,
                                total_earnings: 0.00,
                                lifetime_ads_watched: 0,
                                daily_ads_completed: 0,
                                last_ad_date: new Date().toISOString().split('T')[0],
                                referral_count: 0,
                                referred_by: referred_by,
                                join_date: firebase.firestore.FieldValue.serverTimestamp()
                            };
                            await userRef.set(userData);

                            if (referred_by) {
                                const referrerRef = db.collection('users').doc(referred_by);
                                const referrerDoc = await referrerRef.get();
                                if (referrerDoc.exists) {
                                    await referrerRef.update({ referral_count: firebase.firestore.FieldValue.increment(1) });
                                }
                            }
                        } else {
                            const today = new Date().toISOString().split('T')[0];
                            if (userData.last_ad_date !== today) {
                                await userRef.update({ daily_ads_completed: 0, last_ad_date: today });
                                userData.daily_ads_completed = 0;
                            }
                        }

                        if (!document.body.classList.contains('loaded')) {
                            document.body.classList.add('loaded');
                        }
                        updateAllUI(userData);

                    }, (error) => {
                        showError("Error listening to database updates.", error);
                    });

                } catch (error) {
                    showError("An error occurred during app initialization.", error);
                }
            });

        } catch (error) {
            showError("A critical error occurred while initializing Firebase.", error);
        }

        function updateAllUI(user) {
            // এটি একটি উদাহরণ UI আপডেট। আপনার HTML অনুযায়ী এটি পরিবর্তন হবে।
            if (!user) return;
            const fullName = `${user.first_name || ''} ${user.last_name || ''}`.trim();
            document.querySelectorAll('.user-dynamic-name').forEach(el => el.textContent = fullName);
            document.querySelectorAll('.header-available-balance').forEach(el => el.textContent = (user.available_balance || 0).toFixed(2));
        }

    </script>
</body>
</html>
